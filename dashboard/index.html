<link rel="stylesheet" href="nav.css">
<link rel="stylesheet" href="../css/chip.css?3">
<!-- Bootstrap CSS -->
<link rel="stylesheet" href="../css/bootstrap.min.css">
<!-- jQuery -->
<script src="../js/jquery.min.js"></script>
<!-- Bootstrap JS -->
<script src="../js/bootstrap.min.js"></script>
<!-- Firebase JavaScript SDK -->
<script src="https://www.gstatic.com/firebasejs/8.4.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.4.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.4.1/firebase-database.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="../js/firebaseDefaultConfig.js" defer></script>
<script src="../js/nav.js" defer></script>
<script src="../js/chip.js?2" defer></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.4/Chart.js"></script>
<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
<div id="navBar"></div>

<div class="page-content p-3  " id="content">

  <div class="loading style-2" id="loaderOverlay">
    <div class="loading-wheel"></div>
  </div>



  <!-- Toggle button -->
  <button id="sidebarCollapse" type="button" class="btn btn-light bg-white rounded-pill shadow-sm px-4 mb-4"><i
      class="fa fa-bars mr-2"></i><small class="text-uppercase font-weight-bold">Toggle</small></button>

  <fieldset>
    <!-- <legend>
      <span class="" style="font-size: large;">Project</span>
    </legend> -->
    <div class="chip-group" tabindex="-1" role="radiogroup" id="projectChip">
    </div>
  </fieldset>
  


  <div class="separator"></div>

  <div class="row ">
    <div class="col">
      <canvas id="chartNumberUser" style="width:100%;max-width:700px"></canvas>
    </div>

    <div class="col">
      <canvas id="chartPlayTime" style="width:100%;max-width:700px"></canvas>
    </div>
    <div class="col">
      <canvas id="chartSessionCount" style="width:100%;max-width:700px"></canvas>
    </div>
  </div>
  <div class="row ">


    <div class="col">
      <canvas id="chartPlayTimeAvg" style="width:100%;max-width:700px"></canvas>
    </div>

    <div class="col">
      <!-- <canvas id="chartPlayTimeAvg" style="width:100%;max-width:700px"></canvas> -->
    </div>

    <div class="col">
      <!-- <canvas id="chartPlayTimeAvg" style="width:100%;max-width:700px"></canvas> -->
    </div>

  </div>
  <!-- <div class="row ">
    <div class="col-md-4">
      <span class="" style="font-size: medium;">Retention D1: </span><span id="retentionDay1"></span>
    </div>
    <div class="col-md-4">
      <span class="" style="font-size: medium;">Thời gian chơi trung bình:</span><span id="avgPlayTime"></span>
    </div>
    <div class="col-md-4">
      <span class="" style="font-size: medium;">Số lần chơi trung bình: </span><span id="avgSession"></span>
    </div>
  </div> -->

  <div class="separator"></div>

  <fieldset>
    <legend>
      <span class="" style="font-size: large;">Version</span>
    </legend>
    <div class="chip-group" tabindex="-1" role="radiogroup" id="versionChip">
    </div>
  </fieldset>

  <div class="row ">
  </div>

  <div class="separator"></div>
  <fieldset>
    <legend>
      <span class="" style="font-size: large;">Level Status</span>
    </legend>
    <!-- <div class="chip-group" tabindex="-1" role="radiogroup" id="versionChip"> -->
    <!-- </div> -->
  </fieldset>


  <div class="row ">
    
    
    <div class="col">
      <canvas id="chartUserLevel" style="width:100%;max-width:700px"></canvas>
    </div>

    <div class="col">
      <canvas id="chartLevelLose" style="width:100%;max-width:700px"></canvas>
    </div>

    <div class="col">
      <canvas id="chartLevelTimeSpent" style="width:100%;max-width:700px"></canvas>
    </div>
  </div>

  <div class="row ">
    
    
    <div class="col">
      <canvas id="chartUserLevelCount" style="width:100%;max-width:700px"></canvas>
    </div>

    <div class="col">
      <canvas id="chartLevelWinPercent" style="width:100%;max-width:700px"></canvas>
    </div>

    <div class="col">
      <canvas id="chartLevelDropPercent" style="width:100%;max-width:700px"></canvas>
    </div>
  </div>

  <div class="separator"></div>
  <fieldset>
    <legend>
      <span class="" style="font-size: large;">Retention and Language</span>
    </legend>
    <!-- <div class="chip-group" tabindex="-1" role="radiogroup" id="versionChip"> -->
    <!-- </div> -->
  </fieldset>

  <div class="row ">
    
    
    <div class="col">
      <canvas id="chartRetentionCohort" style="width:100%;max-width:700px"></canvas>
    </div>

    <div class="col">
      <canvas id="chartRetentionPercent" style="width:100%;max-width:700px"></canvas>
    </div>

    <div class="col">
      <table class="table table-striped">
        <thead>
          <tr>
            <th scope="col">#</th>
            <th scope="col">Name</th>
            <th scope="col">Value</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <th scope="row">1</th>
            <td>Retention D1</td>
            <td><span id="retentionD1">30%</span></td>
          </tr>
          <tr>
            <th scope="row">1</th>
            <td>Retention D3</td>
            <td><span id="retentionD3">30%</span></td>
          </tr>
          <tr>
            <th scope="row">1</th>
            <td>Retention D7</td>
            <td><span id="retentionD7">30%</span></td>
          </tr>
          <tr>
            <th scope="row">1</th>
            <td>Retention D30</td>
            <td><span id="retentionD30">30%</span></td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <div class="row ">
    <div class="col">
      <canvas id="chartUserByDay" style="width:100%;max-width:700px"></canvas>
    </div>
    
    <div class="col">
      <canvas id="chartLanguage" style="width:100%;max-width:700px"></canvas>
    </div>

    <div class="col">
      <canvas id="chartLanguagePlayTime" style="width:100%;max-width:700px"></canvas>
    </div>
  </div>

  <div class="row ">
    <div class="col">
      <canvas id="chartUserPlayDay" style="width:100%;max-width:700px"></canvas>
    </div>
    
    <div class="col">
      <!-- <canvas id="chartLanguage" style="width:100%;max-width:700px"></canvas> -->
    </div>

    <div class="col">
      <!-- <canvas id="chartLanguagePlayTime" style="width:100%;max-width:700px"></canvas> -->
    </div>
  </div>

  <div class="separator"></div>
  <fieldset>
    <legend>
      <span class="" style="font-size: large;">Finance</span>
    </legend>
    <!-- <div class="chip-group" tabindex="-1" role="radiogroup" id="versionChip"> -->
    <!-- </div> -->
  </fieldset>

  <div class="row ">
    <div class="col">
      <canvas id="chartRevenue" style="width:100%;max-width:700px"></canvas>
    </div>

    <div class="col">
      <canvas id="chartRevenuePerUser" style="width:100%;max-width:700px"></canvas>
    </div>

    <div class="col">
      <canvas id="chartImpressionPerUser" style="width:100%;max-width:700px"></canvas>
    </div>
  </div>

  <div class="row ">
    <div class="col">
      <canvas id="chartImpressionPerSession" style="width:100%;max-width:700px"></canvas>
    </div>

    <div class="col">
      <!-- <canvas id="chartRevenuePerUser" style="width:100%;max-width:700px"></canvas> -->
    </div>

    <div class="col">
      <!-- <canvas id="chartImpressionPerUser" style="width:100%;max-width:700px"></canvas> -->
    </div>
  </div>

  <div class="row ">
    <div class="col">
      <div class="row">
        <span style="font-size: medium;">Input ads spend: </span>
        <div class="col">
          <input id="inputAdSpend" value="0" />
        </div>
      </div>
    
      <div class="row">
        <span style="font-size: medium;">Input Revenue: </span>
        <div class="col">
          <input id="inputRevenue" value="0" />
        </div>
      </div>
      <br>
      <div class="row">
        <div class="col">
          <button id="calculate" class="btn btn-primary" onclick=calculateRevenue()>Tính toán</button>
        </div>
      </div>
    </div>
    
    <div class="col">
      <!-- <canvas id="chartLanguage" style="width:100%;max-width:700px"></canvas> -->
      <table class="table table-striped">
        <thead>
          <tr>
            <th scope="col">#</th>
            <th scope="col">Name</th>
            <th scope="col">Value</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <th scope="row">1</th>
            <td>User acquisition</td>
            <td><span id="userAcquisition">0</span></td>
          </tr>
          <tr>
            <th scope="row">1</th>
            <td>Revenue per user</td>
            <td><span id="revenuePerUser">0.00$</span></td>
          </tr>
          <tr>
            <th scope="row">1</th>
            <td>User CPI</td>
            <td><span id="userCPI">0.00$</span></td>
          </tr>
          <tr>
            <th scope="row">1</th>
            <td>ROAS</td>
            <td><span id="roas">0.00%</span></td>
          </tr>
        </tbody>
      </table>
    </div>

    <div class="col">
      <!-- <canvas id="chartLanguagePlayTime" style="width:100%;max-width:700px"></canvas> -->
    </div>
  </div>



  <div class="row ">

  

</div>
<script>
  var projectConfig = {};
  var allData = [];
  var dicProjectDatas = {};
  var dicCharts = {};

  $(function () {
    $('#loaderOverlay').hide();
    // Check if the cookie exists or cookie already expried
    if (document.cookie.indexOf("username") === -1) {
      window.location.assign('/login');
    }
    // Sidebar toggle behavior
    $('#sidebarCollapse').on('click', function () {
      $('#sidebar, #content').toggleClass('active');
    });
    getData().then((data) => {
      console.log(data);
    }).catch((error) => {
      console.error(error);
    });
  });

  async function getData() {
    let defaultProject = '';
    defaultDb.goOnline();
    const snapshot = await databaseConfig.get();
    console.log("get data!");
    console.log(snapshot.toJSON());
    let firstKey;
    snapshot.forEach((childSnapshot) => {
      if (!firstKey) {
        firstKey = childSnapshot.key;
      }
      var keystr = childSnapshot.key;
      var value = childSnapshot.val();
      projectConfig[keystr] = value;
      firebase.initializeApp(value, keystr);
      defaultProject = keystr;

      let htmlPattern = `<div class="chip chip-checkbox" aria-labelledby="${keystr}" tabindex="0" role="radio"
                aria-checked="false" onclick="onSelectProject('${keystr}')">
                <input type="radio" id="${keystr}" name="project" value="${keystr}"/>
                <span>${keystr}</span></div>`;
      $('#projectChip').append(htmlPattern);
    });
    return firstKey;
  }

  function onSelectProject(project) {
    let rawData;

    if (dicProjectDatas[project] != null) {
      rawData = dicProjectDatas[project];
      updateProjectData(rawData);
      return;
    }

    $('#loaderOverlay').show();
    const db = firebase.app(project).database();
    db.goOnline();
    let ref = db.ref().orderByKey();

    ref.once('value', (snapshot) => {
      $('#loaderOverlay').hide();
      rawData = snapshot.val();
      dicProjectDatas[project] = rawData;
      updateProjectData(rawData);
    });
  }

  let versions = [];
  let versionHaveUsers = [];
  let userCounts = [];
  let playTimes = [];
  let sessionCounts = [];
  let playTimeEachSessions = [];

  function updateProjectData(rawData) {
    versions = [];
    versionHaveUsers = [];
    userCounts = [];
    playTimes = [];
    sessionCounts = [];
    playTimeEachSessions = [];

    console.log("raw data = ");
    console.log(rawData);

    // $('#dataUser').text('');
    $('#versionChip').children().remove();

    for (const versionName in rawData) {
      console.log(`${versionName}: ${rawData[versionName]}`);
      let userdata = rawData[versionName]["userdata"];
      console.log("get userdata for version " + versionName);
      console.log(userdata);
      console.log("userdata length = " + Object.keys(userdata).length);
      calculateAll(userdata);
      versions.push(versionName);
      userCounts.push(userCount);

      if (userCount >= MIN_NUMBER_USER_ANALYTICS) {
        versionHaveUsers.push(versionName);

        let playTimeEachUser = totalPlayTime / userCount / 60;
        let sessionEachUser = totalSessionCount / userCount;
        playTimes.push(playTimeEachUser.toFixed(2));
        sessionCounts.push(sessionEachUser.toFixed(2));
        playTimeEachSessions.push((playTimeEachUser / sessionEachUser).toFixed(2));

        let htmlPattern = `<div class="chip chip-checkbox" aria-labelledby="${versionName}" tabindex="0" role="radio"
                aria-checked="false" onclick="updateVersionData('${versionName}')">
                <input type="radio" id="${versionName}" name="version" value="${versionName}"/>
                <span>${versionName}</span>
            </div>`;
        $('#versionChip').append(htmlPattern);
      }
    }
    drawChart("chartNumberUser", "Số lượng user", versions, userCounts);

    drawChart("chartPlayTime", "Tổng thời gian chơi (phút)", versionHaveUsers, playTimes);
    drawChart("chartSessionCount", "Số lượng session", versionHaveUsers, sessionCounts);
    drawChart("chartPlayTimeAvg", "Thời gian chơi mỗi session", versionHaveUsers, playTimeEachSessions);
  }

  let dicUserDate = {};
  let dicLanguage = {};
  let dicLanguagePlayTime = {};
  let dicRetention = {};
  let dicRetentionCohort = {};
  let dicRetentionPercent = {};
  let dicPlayDayCount = {};
  let dicHavePlay = {};

  function updateVersionData(version) {
    dicUserDate = {};
    dicLanguage = {};
    dicLanguagePlayTime = {};
    dicRetention = {};
    dicRetentionCohort = {};
    dicRetentionPercent = {};
    dicUserDropPercent = {};
    dicPlayDayCount = {};
    dicHavePlay = {};

    let project = $('input[name=project]:checked').val();
    let versionData = dicProjectDatas[project][version]["userdata"];
    let str = "";

    str += "this is pikachu\n";
    console.log("this is verrsion data");
    console.log(versionData);
    //checking basic stats
    for (const userId in versionData) {
      let user = versionData[userId];
      let isRealUser = user['installerName'] == 'com.android.vending';
      if (isRealUser == false) continue;

      let words = userId.split("_");
      console.log(words[0]);
      str += words[0];

      let dateStr = words[0];

      let year = "20" + dateStr[0] + dateStr[1];
      let month = parseInt(dateStr[2] + dateStr[3]);
      let day = parseInt(dateStr[4] + dateStr[5]);
      let date = new Date(year,month - 1,day);

      const differenceInMs = new Date().getTime() - date.getTime();
      const playDay = Math.floor(differenceInMs / (1000 * 60 * 60 * 24));
      console.log(`play day = ${playDay}, retention type = ${user["retentionType"]}`);

      let retentionType = parseInt(user["retentionType"]);
      
      count(dicUserDate, words[0]);
      count(dicLanguage, user["language"]);
      add(dicLanguagePlayTime, user["language"], user["totalPlayTime"]);
      count(dicRetention, user["retentionType"]);
      count(dicPlayDayCount, playDay);
    }
    //checking playtime by language
    for (const language in dicLanguagePlayTime) {
      let userCount = dicLanguage[language];
      if (userCount == 0) {
        dicLanguagePlayTime[language] = 0;
      }
      else {
        dicLanguagePlayTime[language] = (dicLanguagePlayTime[language] / 60 / userCount).toFixed(2);
      }
    }
    //checking retention
    for(let i = 0; i <= 30; i++){
      console.log("checking retention " + i);
      let sum = 0;
      for (const retentionType in dicRetention) {      
        if (retentionType >= i){
          sum += Number(dicRetention[retentionType]);
        }
      }
      dicRetentionCohort[i] = sum;
      dicRetentionPercent[i] = (dicRetentionCohort[i] / dicRetentionCohort[0] * 100).toFixed(2);
    }

    calculateLevel(versionData);
    calculateRevenue(versionData);

    drawChartByDictionary("chartUserByDay","Số user mới theo ngày", dicUserDate);
    drawChartByDictionary("chartLanguage", "Số user theo ngôn ngữ", dicLanguage);
    drawChartByDictionary("chartLanguagePlayTime", "Thời gian chơi theo từng ngôn ngữ (phút)", dicLanguagePlayTime);
    drawChartByDictionary("chartRetention", "Retention user", dicRetention);
    drawChartByDictionary("chartRetentionCohort", "Retention user by cohort", dicRetentionCohort);
    drawChartByDictionary("chartRetentionPercent", "Retention user by cohort (%)", dicRetentionPercent);
    drawChartByDictionary("chartUserPlayDay", "Day count since first play", dicPlayDayCount);
    $('#retentionD1').text(dicRetentionPercent[1] + "%");
    $('#retentionD3').text(dicRetentionPercent[3] + "%");
    $('#retentionD7').text(dicRetentionPercent[7] + "%");
    $('#retentionD30').text(dicRetentionPercent[30] + "%");
    // $('#dataUser').text(JSON.stringify(str));
  }

  let dicLevel = {};
  let dicLose = {};
  let dicWin = {};
  let dicLevelTimeSpent = {};
  let dicLevelCount = {};
  let dicUserDropPercent = {};
  let dicLevelPlayCount = {};
  
  function calculateLevel(versionData){
    dicLevel = {};
    dicLevelCount = {};
    dicLose = {};
    dicWin = {};
    dicLevelTimeSpent = {};    
    dicUserDropPercent = {};
    dicLevelPlayCount = {};

    let userCount = 0;
    let maxLevel = 0;

    for (const userId in versionData) {
      let user = versionData[userId];
      let isRealUser = user['installerName'] == 'com.android.vending';
      if (isRealUser == false) continue;

      let winlose = user["winloseDatas"];
      if (winlose == null) continue;

      userCount++;
      let level = user["level"];
      if (level > maxLevel) maxLevel = level;

      count(dicLevel, level);
      for (let i = 0; i <= level; i++) {
        count(dicLevelCount, i);
      }
      
      for (const level in winlose) {
        let winloseData = winlose[level];
        add(dicLose, level, winloseData["loseCount"]);
        add(dicWin, level, winloseData["winCount"]);
        add(dicLevelTimeSpent, level, winloseData["timeSpent"]);
        count(dicLevelPlayCount, level);
        // dicLose[level] += winloseData["loseCount"];
        // dicLevelTimeSpent[level] += winloseData["timeSpent"];
      }
    }

    for (let i = 1; i <= maxLevel; i++) {
      let percent = (1 - dicLevelCount[i]/dicLevelCount[i-1]) *100;
      dicUserDropPercent[i-1] = percent.toFixed(2);
    }
    dicUserDropPercent[maxLevel] = 100;

    let dicWinPercent = {};

    for (const key in dicLose) {
      if (dicWin[key] == null) continue;
      let lose = dicLose[key];
      let win = dicWin[key];
      dicWinPercent[key] = ((win / (win + lose)) *100).toFixed(2);
    }

    let dicLosePerUser = {};
    for (const key in dicLose) {
      dicLosePerUser[key] = dicLose[key] / dicLevelPlayCount[key];
    }
    
    for (const key in dicLevelTimeSpent) {
      dicLevelTimeSpent[key] = dicLevelTimeSpent[key] / dicLevelPlayCount[key];
    }

    drawChartByDictionary("chartUserLevel", "User by level", dicLevel);
    drawChartByDictionary("chartUserLevelCount", "Number user pass level", dicLevelCount);
    drawChartByDictionary("chartLevelLose", "Lose Level Per User", dicLosePerUser);
    drawChartByDictionary("chartLevelTimeSpent", "Level Time Spent Per User", dicLevelTimeSpent);
    drawChartByDictionary("chartLevelWinPercent", "Level Win Percent", dicWinPercent);
    drawChartByDictionary("chartLevelDropPercent", "User Give Up Percent by level", dicUserDropPercent);
  }

  function calculateRevenue(versionData){
    dicRevenue = {};
    dicRevenuePerUser = {};
    dicImpressionPerUser = {};
    dicImpressionPerSession = {};

    let revenueBanner = 0;
    let revenueIntertistial = 0;
    let revenueRewarded = 0;
    let revenueAppOpen = 0;
    let userCount = 0;
    let sessionCount = 0;

    let impressionBanner = 0;
    let impressionIntertistial = 0;
    let impressionRewarded = 0;
    let impressionAppOpen = 0;

    for (const userId in versionData) {
      let user = versionData[userId];
      let isRealUser = user['installerName'] == 'com.android.vending';
      if (isRealUser == false) continue;

      userCount++;
      sessionCount += user["sessionCount"];
      let revenue = user["revenue"];
      revenueBanner += revenue["bannerRevenue"];
      revenueIntertistial += revenue["interRevenue"];
      revenueRewarded += revenue["rewardRevenue"];
      revenueAppOpen += revenue["appOpenRevenue"];

      impressionBanner += revenue["bannerSuccess"];
      impressionIntertistial += revenue["interSuccess"];
      impressionRewarded += revenue["rewardSuccess"];
      impressionAppOpen += revenue["appOpenSuccess"];
      
      console.log("revenue detail = " + revenue);
    }
    let totalRevenue = revenueAppOpen + revenueBanner + revenueIntertistial + revenueRewarded;
    let totalImpression = impressionBanner + impressionAppOpen + impressionIntertistial + impressionRewarded;

    dicRevenue["total"] = totalRevenue;
    dicRevenue["banner"] = revenueBanner;
    dicRevenue["intertistial"] = revenueIntertistial;
    dicRevenue["rewarded"] = revenueRewarded;
    dicRevenue["app open"] = revenueAppOpen;

    dicRevenuePerUser["total"] = totalRevenue / userCount;
    dicRevenuePerUser["banner"] = revenueBanner / userCount;
    dicRevenuePerUser["intertistial"] = revenueIntertistial / userCount;
    dicRevenuePerUser["rewarded"] = revenueRewarded / userCount;
    dicRevenuePerUser["app open"] = revenueAppOpen / userCount;

    dicImpressionPerUser["total"] = totalImpression / userCount;
    dicImpressionPerUser["banner"] = impressionBanner / userCount;
    dicImpressionPerUser["intertistial"] = impressionIntertistial / userCount;
    dicImpressionPerUser["rewarded"] = impressionRewarded / userCount;
    dicImpressionPerUser["app open"] = impressionAppOpen / userCount;

    dicImpressionPerSession["total"] = totalImpression / sessionCount;
    dicImpressionPerSession["banner"] = impressionBanner / sessionCount;
    dicImpressionPerSession["intertistial"] = impressionIntertistial / sessionCount;
    dicImpressionPerSession["rewarded"] = impressionRewarded / sessionCount;
    dicImpressionPerSession["app open"] = impressionAppOpen / sessionCount;

    drawChartByDictionary("chartRevenue", "Revenue", dicRevenue);
    drawChartByDictionary("chartRevenuePerUser", "Revenue Per User", dicRevenuePerUser);
    drawChartByDictionary("chartImpressionPerUser", "Impression Per User", dicImpressionPerUser);
    drawChartByDictionary("chartImpressionPerSession", "Impression Per Session", dicImpressionPerSession);
  }

  function count(dic, key){
    if (dic[key] == null){
      dic[key] = 1;
    } else {
      dic[key]++;
    }
  }

  function add(dic, key, value){
    if (dic[key] == null){
      // console.log("set key = " + key + " , value = " + value);
      dic[key] = value;
    } else {
      dic[key] += value;
      // console.log("add key = " + key + " , value = " + value + ", total value = " + dic[key]);
    }
  }

  function calculateRevenue1(){
    let adSpend = $("#inputAdSpend").val();
    console.log("ad spend = " + adSpend);
    let totalRevenue = $("#inputRevenue").val();
    console.log("total revenue = " + totalRevenue);
    console.log("user count = " + dicRetentionCohort[0]);
    let revenuePerUser = totalRevenue / dicRetentionCohort[0];
    console.log("revenue per user = " + revenuePerUser.toFixed(2));
    console.log("money spend: " + adSpend);
    let userCPI = adSpend / dicRetentionCohort[0];
    console.log("user CPI = " + userCPI.toFixed(2));
    let roas = (revenuePerUser / userCPI * 100).toFixed(2);
    console.log("revenue per CPI = " + roas + "%");

    $("#userAcquisition").text(dicRetentionCohort[0]);
    $("#revenuePerUser").text(revenuePerUser.toFixed(4) + "$");
    $("#userCPI").text(userCPI.toFixed(4) + "$");
    $("#roas").text(roas + "%");
  }

  function drawChartByDictionary(chartName, title, dic){
    let columnNames = [];
    let values = [];
    for (const key in dic) {
      columnNames.push(key);
      values.push(dic[key]);
    }
    drawChart(chartName, title, columnNames, values);
  }

  function drawChart(chartName, title, columnNames, values) {
    if (dicCharts[chartName] != null) {
      dicCharts[chartName].destroy();
    }
    let barColors = [];
    // let colors = ["red", "orange", "green", "blue", "purple"];
    let colors = ["green", "blue", "purple", "red", "orange"];
    for (let i = 0; i < columnNames.length; i++) {
      let colorIndex = i % colors.length;
      // console.log("color index = " + colorIndex + " , colors[colorIndex] = " + colors[colorIndex]);
      barColors.push(colors[colorIndex]);
    }
    let chart = new Chart(chartName, {
      type: "bar",
      data: {
        labels: columnNames,
        datasets: [{
          label: title,
          backgroundColor: barColors,
          data: values
        }]
      },
      options: {
        scales: {
          yAxes: [{
            ticks: {
              beginAtZero: true
            }
          }]
        }
      }
    });
    dicCharts[chartName] = chart;
    return chart;
  }

  const MIN_NUMBER_USER_ANALYTICS = 10;

  let retentionDay0 = 0;
  let retentionDay1 = 0;
  let totalPlayTime = 0;
  let totalSessionCount = 0;
  let userCount = 0;

  function calculateAll(allData) {
    retentionDay0 = 0;
    retentionDay1 = 0;
    totalPlayTime = 0;
    totalSessionCount = 0;
    userCount = 0;

    for (const property in allData) {
      var user = allData[property];
      let isRealUser = user['installerName'] == 'com.android.vending';
      if (isRealUser == false) continue;
      userCount++;

      let playTime = user["totalPlayTime"];
      totalPlayTime += playTime;

      let sessionCount = user["sessionCount"];
      totalSessionCount += sessionCount;
    }
  }
</script>

</html>