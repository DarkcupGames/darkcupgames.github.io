<link rel="stylesheet" href="nav.css">
<link rel="stylesheet" href="../css/chip.css?3">
<!-- Bootstrap CSS -->
<link rel="stylesheet" href="../css/bootstrap.min.css">
<!-- jQuery -->
<script src="../js/jquery.min.js"></script>
<!-- Bootstrap JS -->
<script src="../js/bootstrap.min.js"></script>
<!-- Firebase JavaScript SDK -->
<script src="https://www.gstatic.com/firebasejs/8.4.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.4.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.4.1/firebase-database.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="../js/firebaseDefaultConfig.js" defer></script>
<script src="../js/nav.js" defer></script>
<script src="../js/chip.js?2" defer></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.4/Chart.js"></script>
<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
<div id="navBar"></div>

<div class="page-content p-3" style="padding-top: 200px important!;" id="content">

  <div class="loading style-2" id="loaderOverlay">
    <div class="loading-wheel"></div>
  </div>

  <fieldset class="floating-group">
    <div style="float: left; margin-right: 8px;" >
      <button id="sidebarCollapse" type="button" class="btn btn-light bg-white rounded-pill shadow-sm px-4 mb-4"><i
        class="fa fa-bars mr-2"></i><small class="text-uppercase font-weight-bold">Toggle</small></button>
    </div>
    <div class="chip-group" tabindex="-1" role="radiogroup" id="projectChip" style="float: left;">
    </div>
    <!-- <div>
      <span class="" style="font-size: large;">Version</span>
    </div> -->
    <div class="chip-group" tabindex="-1" role="radiogroup" id="versionChip" style="float: left;">
    </div>
  </fieldset>



  <div class="separator" style="height: 100px;"></div>

  <div class="row ">
    <div class="col-3">
      <canvas id="chartNumberUser" style="max-width:700px"></canvas>
    </div>

    <div class="col-3">
      <canvas id="chartPlayTime" style="max-width:700px"></canvas>
    </div>
    <div class="col-3">
      <canvas id="chartSessionCount" style="max-width:700px"></canvas>
    </div>

    <div class="col-3">
      <canvas id="chartPlayTimeAvg" style="max-width:700px"></canvas>
    </div>

  </div>

  <div class="row ">



    <div class="col">
      <!-- <canvas id="chartRevenuePerUserEachVersion" style="width:100%;max-width:700px"></canvas> -->
      <canvas id="chartImpressionPerUserEachVersion" style="width:100%;max-width:700px"></canvas>
    </div>

    <div class="col">
      
      <canvas id="chartRewardedPerUserEachVersion" style="width:100%;max-width:700px"></canvas>
    </div>

    <div class="col">
      <canvas id="chartIntertistialCapping" style="width:100%;max-width:700px"></canvas>
    </div>


    <div class="col">
      <canvas id="chartTrashUserPercent" style="width:100%;max-width:700px"></canvas>
    </div>


  </div>
  <div class="separator"></div>
  <fieldset>
    <legend>
      <span class="" style="font-size: large;">Marketing Status</span>
    </legend>
    <!-- <div class="chip-group" tabindex="-1" role="radiogroup" id="versionChip"> -->
    <!-- </div> -->
  </fieldset>
  <div class="row " id="marketingStatus">
    <div class="col-4">
      <table class="table table-striped">
        <thead>
          <tr>
            <th scope="col">#</th>
            <th scope="col">Name</th>
            <th scope="col">Value</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <th scope="row">1</th>
            <td>Total Ad Spend</td>
            <td><span id="marketStatus_adSpend">30%</span></td>
          </tr>
          <tr>
            <th scope="row">1</th>
            <td>Total Revenue</td>
            <td><span id="marketStatus_revenue">30%</span></td>
          </tr>
          <tr>
            <th scope="row">1</th>
            <td>Total Profit/Loss</td>
            <td><span id="marketStatus_profit">30%</span></td>
          </tr>
          <tr>
            <th scope="row">1</th>
            <td>ROAS</td>
            <td><span id="marketStatus_roas">30%</span></td>
          </tr>
        </tbody>
      </table>
    </div>
    <div class="col-8">
      <canvas id="chartMarketingStatus" style="width:100%;"></canvas>
    </div>
  </div>
  <div class="row">
    <div class="col-6">
      <canvas id="chartMarketingCPI" style="width:100%;"></canvas>
    </div>
    <div class="col-6">
      <canvas id="chartMarketingTrashPercent" style="width:100%;"></canvas>
    </div>
  </div>

  <div class="separator"></div>
  <fieldset>
    <legend>
      <span class="" style="font-size: large;">Level Status</span>
    </legend>
    <!-- <div class="chip-group" tabindex="-1" role="radiogroup" id="versionChip"> -->
    <!-- </div> -->
  </fieldset>


  <div class="row ">

    <div class="col">
      <canvas id="chartUserLevelCount" style="width:100%;max-width:700px"></canvas>
    </div>


    <div class="col">
      <canvas id="chartLevelLose" style="width:100%;max-width:700px"></canvas>
    </div>

    <div class="col">
      <canvas id="chartLevelTimeSpent" style="width:100%;max-width:700px"></canvas>
    </div>

  </div>

  <div class="row ">
    
    <div class="col">
      <canvas id="chartUserByLosePercent" style="width:100%;max-width:700px"></canvas>
    </div>

    <div class="col">

      <canvas id="chartLevelDropPercent" style="width:100%;max-width:700px"></canvas>
      <!-- <canvas id="chartLevelWinPercent" style="width:100%;max-width:700px"></canvas> -->
    </div>

    <div class="col">

      <canvas id="chartUserPlayTimeByLosePercent" style="width:100%;max-width:700px"></canvas>
    </div>
  </div>


  <div class="row ">
    
    <div class="col">
    
    </div>

    <div class="col">
      <!-- <canvas id="chartLevelWinPercent" style="width:100%;max-width:700px"></canvas> -->
    </div>

    <div class="col">
      <!-- <canvas id="chartLevelDropPercent" style="width:100%;max-width:700px"></canvas> -->
    </div>
  </div>


  <div class="separator"></div>
  <fieldset>
    <legend>
      <span class="" style="font-size: large;">Quit Reason</span>
    </legend>
    <!-- <div class="chip-group" tabindex="-1" role="radiogroup" id="versionChip"> -->
    <!-- </div> -->
  </fieldset>

  <div class="row ">
    
    
    <div class="col">
      <canvas id="chartQuitReason" style="width:100%;max-width:700px"></canvas>
    </div>

    <div class="col">
      <canvas id="chartQuitReason_BoringGameplay" style="width:100%;max-width:700px"></canvas>
    </div>

    <div class="col">
      <canvas id="chartQuitReason_IntertistialAds" style="width:100%;max-width:700px"></canvas>
    </div>
  </div>

  <div class="separator" style="display: none;"></div>
  <fieldset style="display: none;">
    <legend>
      <span class="" style="font-size: large;">User Status</span>
    </legend>
    <!-- <div class="chip-group" tabindex="-1" role="radiogroup" id="versionChip"> -->
    <!-- </div> -->
  </fieldset>



  <div class="row " style="display: none;">
    
    
    <div class="col">
      <canvas id="chartUserProperty" style="width:100%;max-width:700px"></canvas>
    </div>

    <div class="col">
      <canvas id="chartUserPropertyPercent" style="width:100%;max-width:700px"></canvas>
    </div>

    <div class="col">
      <!-- <canvas id="chartQuitReason_IntertistialAds" style="width:100%;max-width:700px"></canvas> -->
    </div>
  </div>

  <div class="separator"></div>
  <fieldset>
    <legend>
      <span class="" style="font-size: large;">Retention and Language</span>
    </legend>
    <!-- <div class="chip-group" tabindex="-1" role="radiogroup" id="versionChip"> -->
    <!-- </div> -->
  </fieldset>

  <div class="row ">
    <div class="col">
      <canvas id="chartRetentionCohort" style="width:100%;max-width:700px"></canvas>
    </div>

    <div class="col">
      <canvas id="chartRetentionPercent" style="width:100%;max-width:700px"></canvas>
    </div>

    <div class="col">
      <table class="table table-striped">
        <thead>
          <tr>
            <th scope="col">#</th>
            <th scope="col">Name</th>
            <th scope="col">Value</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <th scope="row">1</th>
            <td>Retention D1</td>
            <td><span id="retentionD1">30%</span></td>
          </tr>
          <tr>
            <th scope="row">1</th>
            <td>Retention D3</td>
            <td><span id="retentionD3">30%</span></td>
          </tr>
          <tr>
            <th scope="row">1</th>
            <td>Retention D7</td>
            <td><span id="retentionD7">30%</span></td>
          </tr>
          <tr>
            <th scope="row">1</th>
            <td>Retention D30</td>
            <td><span id="retentionD30">30%</span></td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <div class="row ">
    <div class="col">
      <canvas id="chartUserByDay" style="width:100%;max-width:700px"></canvas>
    </div>
    
    <div class="col">
      <canvas id="chartLanguage" style="width:100%;max-width:700px"></canvas>
    </div>

    <div class="col">
      <canvas id="chartLanguagePlayTime" style="width:100%;max-width:700px"></canvas>
    </div>
  </div>

  <!-- <div class="row ">
    <div class="col">
      <canvas id="chartUserPlayDay" style="width:100%;max-width:700px"></canvas>
    </div>
    
    <div class="col">
      <canvas id="chartLanguage" style="width:100%;max-width:700px"></canvas>
    </div>

    <div class="col">
      <canvas id="chartLanguagePlayTime" style="width:100%;max-width:700px"></canvas>
    </div>
  </div> -->

  <div class="separator"></div>
  <fieldset>
    <legend>
      <span class="" style="font-size: large;">Finance</span>
    </legend>
    <!-- <div class="chip-group" tabindex="-1" role="radiogroup" id="versionChip"> -->
    <!-- </div> -->
  </fieldset>

  <div class="row ">
    <div class="col">
      <table class="table table-striped">
        <thead>
          <tr>
            <th scope="col">#</th>
            <th scope="col">Name</th>
            <th scope="col">Value</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <th scope="row">1</th>
            <td>Total revenue</td>
            <td><span id="revenueTotal">0</span></td>
          </tr>
          <tr>
            <th scope="row">1</th>
            <td>This version revenue</td>
            <td><span id="revenueThisVersion">0</span></td>
          </tr>
          <tr>
            <th scope="row">1</th>
            <td>Revenue per user</td>
            <td><span id="revenuePerUser">0.00$</span></td>
          </tr>
          <tr>
            <th scope="row">1</th>
            <td>Intertistial / user</td>
            <td><span id="revenueInterPerUser">0.00$</span></td>
          </tr>
          <tr>
            <th scope="row">1</th>
            <td>Rewarded / user</td>
            <td><span id="revenueRewardPerUser">0.00$</span></td>
          </tr>
          <tr>
            <th scope="row">1</th>
            <td>App Open / user</td>
            <td><span id="revenueAppOpenPerUser">0.00$</span></td>
          </tr>
          <tr>
            <th scope="row">1</th>
            <td>Banner / user</td>
            <td><span id="revenueBannerPerUser">0.00$</span></td>
          </tr>
          <!-- <tr>
            <th scope="row">1</th>
            <td>User CPI</td>
            <td><span id="userCPI">0.00$</span></td>
          </tr>
          <tr>
            <th scope="row">1</th>
            <td>User CPI</td>
            <td><span id="userCPI">0.00$</span></td>
          </tr>
          <tr>
            <th scope="row">1</th>
            <td>ROAS</td>
            <td><span id="roas">0.00%</span></td>
          </tr> -->
        </tbody>
      </table>
      <!-- <canvas id="chartRevenue" style="width:100%;max-width:700px"></canvas> -->
    </div>

    <div class="col">
      <div class="row">
        <canvas id="chartRevenue" style="width:100%;max-width:700px"></canvas>
      </div>

      <div class="row">
        <canvas id="chartImpressionPerUser" style="width:100%;max-width:700px"></canvas>
      </div>

      <div class="row">
        <canvas id="chartRevenuePerImpression" style="width:100%;max-width:700px"></canvas>
      </div>
      
    </div>

    <div class="col">
      <div class="row">
        <canvas id="chartRevenuePerUser" style="width:100%;max-width:700px"></canvas>
      </div>

      <div class="row">
        <canvas id="chartImpressionPerSession" style="width:100%;max-width:700px"></canvas>
      </div>
      
    </div>
  </div>

<div class="separator"></div>
<fieldset>
  <legend>
    <span class="" style="font-size: large;">User Session Snapshots</span>
  </legend>
</fieldset>

<div id="userSessionGroup">
  <div class="row ">
    <div class="col-4">

    </div>
    <div class="col-8">
      <canvas id="chartUserSession_" style="max-width:700px;"></canvas>
    </div>
  </div>
</div>

<div class="row ">
<script>
  var dicProjectDatas = {};
  var allData = [];
  var dicUserDatas = {};
  var dicSessionDatas = {};
  var dicCharts = {};

  $(function () {
    $('#loaderOverlay').hide();
    // Check if the cookie exists or cookie already expried
    if (document.cookie.indexOf("username") === -1) {
      window.location.assign('/login');
    }
    // Sidebar toggle behavior
    $('#sidebarCollapse').on('click', function () {
      $('#sidebar, #content').toggleClass('active');
    });
    getData().then((data) => {
      console.log(data);
    }).catch((error) => {
      console.error(error);
    });
  });

  async function getData() {
    let defaultProject = '';
    defaultDb.goOnline();
    const snapshot = await databaseConfig.get();
    console.log("get data!");
    console.log(snapshot.toJSON());
    let firstKey;
    snapshot.forEach((childSnapshot) => {
      if (!firstKey) {
        firstKey = childSnapshot.key;
      }
      var keystr = childSnapshot.key;
      dicProjectDatas[keystr] = childSnapshot.val();
      var config = dicProjectDatas[keystr] ["connection"];
      firebase.initializeApp(config, keystr);
      defaultProject = keystr;

      let htmlPattern = `<div class="chip chip-checkbox" aria-labelledby="${keystr}" tabindex="0" role="radio"
                aria-checked="false" onclick="onSelectProject('${keystr}')">
                <input type="radio" id="${keystr}" name="project" value="${keystr}"/>
                <span>${keystr}</span></div>`;
      $('#projectChip').append(htmlPattern);
    });
    return firstKey;
  }

  function onSelectProject(project) {
    let rawData;

    querySessionData(project);
    calculateMarketingStatus(project);

    if (dicUserDatas[project] != null) {
      rawData = dicUserDatas[project];
      updateProjectData(rawData);
      return;
    }

    $('#loaderOverlay').show();
    const db = firebase.app(project).database();
    db.goOnline();
    let ref = db.ref("userdata").orderByKey();

    ref.once('value', (snapshot) => {
      $('#loaderOverlay').hide();
      console.log("get data completed");
      console.log(snapshot.val());
      rawData = snapshot.val();
      dicUserDatas[project] = rawData;
      updateProjectData(rawData);
    });
  }
  
  function calculateMarketingStatus(project){
    let projectData = dicProjectDatas[project];
    let adSpend = projectData["adSpend"];
    let revenue = projectData["revenue"];
    let userCount = projectData["userCount"];
    console.log("ad spend: ");
    console.log(adSpend);

    if (adSpend == null || adSpend == undefined){
      $("#marketingStatus").hide();
    } else {
      $("#marketingStatus").show();
    }

    let dicAdSpend = {};
    let dicRevenue = {};
    let dicProfit = {};
    let dicUserCount = {};
    let allKey = [];

    let totalRevenue = 0;
    let totalAdSpend = 0;
    let totalProfit = 0;

    for (const mKey in adSpend){
      let month = adSpend[mKey];
      for (const dKey in month){
        let date = mKey + dKey;
        let value = month[dKey];
        dicAdSpend[date] = value;
        totalAdSpend += value;
        if (allKey.includes(date) == false) allKey.push(date);
      }
    }

    for (const mKey in revenue){
      let month = revenue[mKey];
      for (const dKey in month){
        let date = mKey + dKey;
        let value = month[dKey];
        dicRevenue[date] = value;
        totalRevenue += value;
        if (allKey.includes(date) == false) allKey.push(date);
      }
    }

    for (const mKey in userCount){
      let month = userCount[mKey];
      for (const dKey in month){
        let date = mKey + dKey;
        let value = month[dKey];
        dicUserCount[date] = value;
      }
    }

    totalProfit = totalRevenue - totalAdSpend;
    console.log("all key: ");
    console.log(allKey);
    console.log("dic ad spend");
    console.log(dicAdSpend);

    let finalAdSpend = [];
    let finalRevenue = [];
    let finalProfit = [];
    let finalUserCount = [];
    let finalCPI = [];

    for (const index in allKey){
      let key = allKey[index];
      console.log("key = " + key + " spend = " + dicAdSpend[key] );
      let s = dicAdSpend[key] == null ? 0 : dicAdSpend[key];
      let r =  dicRevenue[key] == null ? 0 :  dicRevenue[key];
      let profit = r - s;

      let uCount = dicUserCount[key] == null ? 0 :  dicRevenue[key];
      let cpi = uCount == 0 ? 0 : s /uCount;

      finalAdSpend.push(s);
      finalRevenue.push(r);
      finalProfit.push(profit);
      finalUserCount.push(uCount);
      finalCPI.push(cpi);
    }
    console.log("profit:");
    console.log(finalProfit);

    $("#marketStatus_profit").text(formatCurrentcy(totalProfit));
    $("#marketStatus_revenue").text(formatCurrentcy(totalRevenue));
    $("#marketStatus_adSpend").text(formatCurrentcy(totalAdSpend));
    $("#marketStatus_roas").text((totalRevenue/totalAdSpend*100).toFixed(2)+ "%");
    // drawMarketingChart("chartMarketingStatus", allKey, finalAdSpend, finalRevenue, finalProfit);
    let dataLabels = ["ad spend", "revenue", "profit"];
    let dataColors = ["red", "blue", "green"];
    let dataValues = [finalAdSpend, finalRevenue, finalProfit];

    drawLineChart("chartMarketingStatus", allKey, dataLabels, dataValues,dataColors );
  }

  function formatCurrentcy(number){
    number = number.toFixed(2);
    if (number > 0) return "$" + number;
    else {
      number = -number;
      return "-$" + number;
    }
  }

  function querySessionData(project){
    if (dicSessionDatas[project] != null) {
      return;
    }

    $('#loaderOverlay').show();
    const db = firebase.app(project).database();
    db.goOnline();
    let ref = db.ref("session").orderByKey();

    ref.once('value', (snapshot) => {
      $('#loaderOverlay').hide();
      dicSessionDatas[project] = snapshot.val();
      countUserTrashPercent(dicSessionDatas[project]);
    });
  }

  let versions = [];
  let versionHaveUsers = [];
  let userCounts = [];
  let playTimes = [];
  let sessionCounts = [];
  let playTimeEachSessions = [];
  let revenuePerUser = [];
  let intertistialPerUser = [];
  let rewardedPerUser = [];
  let intertistialCapping = [];
  let trashUserPercent = [];

  function updateProjectData(rawData) {
    versions = [];
    versionHaveUsers = [];
    userCounts = [];
    playTimes = [];
    sessionCounts = [];
    playTimeEachSessions = [];
    revenuePerUser = [];
    intertistialPerUser = [];
    rewardedPerUser = [];
    intertistialCapping = [];

    let gameTotalRevenue = 0;

    console.log("raw data = ");
    console.log(rawData);

    $('#versionChip').children().remove();

    for (const versionName in rawData) {
      let userdata = rawData[versionName];
      calculateAll(userdata);
      versions.push(versionName);
      userCounts.push(userCount);

      if (userCount >= MIN_NUMBER_USER_ANALYTICS) {
        versionHaveUsers.push(versionName);

        let playTimeEachUser = totalPlayTime / userCount / 60;
        let sessionEachUser = totalSessionCount / userCount;
        playTimes.push(playTimeEachUser.toFixed(2));
        sessionCounts.push(sessionEachUser.toFixed(2));
        playTimeEachSessions.push((playTimeEachUser / sessionEachUser).toFixed(2));

        calculateRevenue(userdata);
        gameTotalRevenue += totalRevenue;
        revenuePerUser.push(totalRevenue / userCount);
        intertistialPerUser.push(impressionIntertistial / userCount);
        rewardedPerUser.push(impressionRewarded / userCount);
        intertistialCapping.push((totalPlayTime / impressionIntertistial / 60).toFixed(2));
        
        let htmlPattern = `<div class="chip chip-checkbox" aria-labelledby="${versionName}" tabindex="0" role="radio"
                aria-checked="false" onclick="updateVersionData('${versionName}')">
                <input type="radio" id="${versionName}" name="version" value="${versionName}"/>
                <span>${versionName}</span>
            </div>`;
        $('#versionChip').append(htmlPattern);
      }
    }
    drawChart("chartNumberUser", "Number of user", versions, userCounts);
    drawChart("chartPlayTime", "Avg total play time avg (minute)", versionHaveUsers, playTimes);
    drawChart("chartSessionCount", "Session count per user", versionHaveUsers, sessionCounts);
    drawChart("chartPlayTimeAvg", "Play time per session", versionHaveUsers, playTimeEachSessions);
    drawChart("chartRevenuePerUserEachVersion", "Revenue per user", versionHaveUsers, revenuePerUser);
    drawChart("chartImpressionPerUserEachVersion", "Intertistial count per user", versionHaveUsers, intertistialPerUser);    
    drawChart("chartRewardedPerUserEachVersion", "Rewarded count per user", versionHaveUsers, rewardedPerUser);   
    drawChart("chartIntertistialCapping", "Time between 2 intertistial (minutes)", versionHaveUsers, intertistialCapping);    
      
    $('#revenueTotal').text(gameTotalRevenue.toFixed(4));
  }

  // function updateSessionData(projectData){
  //   trashUserPercent = [];
  //   console.log("update sessionData");
  //   countUserTrashPercent(projectData);

  //   // for (const versionName in projectData){
  //   //   let session = projectData[versionName];
  //   //   trashUserPercent.push(countUserTrashPercent(session));
  //   //   console.log(session);
  //   // }
  //   // 

  // }

  let dicUserDate = {};
  let dicLanguage = {};
  let dicLanguagePlayTime = {};
  let dicRetention = {};
  let dicRetentionCohort = {};
  let dicRetentionPercent = {};
  let dicPlayDayCount = {};
  let dicHavePlay = {};

  function updateVersionData(version) {
    dicUserDate = {};
    dicLanguage = {};
    dicLanguagePlayTime = {};
    dicRetention = {};
    dicRetentionCohort = {};
    dicRetentionPercent = {};
    dicUserDropPercent = {};
    dicPlayDayCount = {};
    dicHavePlay = {};

    let project = $('input[name=project]:checked').val();
    let versionData = dicUserDatas[project][version];
    let str = "";

    str += "this is pikachu\n";
    console.log("this is verrsion data");
    console.log(versionData);
    //checking basic stats
    for (const userId in versionData) {
      let user = versionData[userId];
      let isRealUser = user['installerName'] == 'com.android.vending';
      if (isRealUser == false) continue;

      let words = userId.split("_");
      // console.log(words[0]);
      str += words[0];

      let dateStr = words[0];

      let year = "20" + dateStr[0] + dateStr[1];
      let month = parseInt(dateStr[2] + dateStr[3]);
      let day = parseInt(dateStr[4] + dateStr[5]);
      let date = new Date(year,month - 1,day);

      const differenceInMs = new Date().getTime() - date.getTime();
      const playDay = Math.floor(differenceInMs / (1000 * 60 * 60 * 24));
      // console.log(`play day = ${playDay}, retention type = ${user["retentionType"]}`);

      let retentionType = parseInt(user["retentionType"]);
      
      count(dicUserDate, words[0]);
      count(dicLanguage, user["language"]);
      add(dicLanguagePlayTime, user["language"], user["totalPlayTime"]);
      count(dicRetention, user["retentionType"]);
      count(dicPlayDayCount, playDay);
    }
    //checking playtime by language
    for (const language in dicLanguagePlayTime) {
      let userCount = dicLanguage[language];
      if (userCount == 0) {
        dicLanguagePlayTime[language] = 0;
      }
      else {
        dicLanguagePlayTime[language] = (dicLanguagePlayTime[language] / 60 / userCount).toFixed(2);
      }
    }
    //checking retention
    for(let i = 0; i <= 30; i++){
      // console.log("checking retention " + i);
      let sum = 0;
      for (const retentionType in dicRetention) {      
        if (retentionType >= i){
          sum += Number(dicRetention[retentionType]);
        }
      }
      dicRetentionCohort[i] = sum;
      dicRetentionPercent[i] = (dicRetentionCohort[i] / dicRetentionCohort[0] * 100).toFixed(2);
    }

    calculateLevel(versionData);
    calculateQuitReason(versionData);
    calculateRevenue(versionData);

    countMarketingTrashPercent(dicUserDate);

    drawChartByDictionary("chartUserByDay","New user by day", dicUserDate);
    drawChartByDictionary("chartLanguage", "User by language", dicLanguage);
    drawChartByDictionary("chartLanguagePlayTime", "Play time by language (minute)", dicLanguagePlayTime);
    drawChartByDictionary("chartRetention", "Retention user", dicRetention);
    drawChartByDictionary("chartRetentionCohort", "Retention user by cohort", dicRetentionCohort);
    drawChartByDictionary("chartRetentionPercent", "Retention user by cohort (%)", dicRetentionPercent);
    $('#retentionD1').text(dicRetentionPercent[1] + "%");
    $('#retentionD3').text(dicRetentionPercent[3] + "%");
    $('#retentionD7').text(dicRetentionPercent[7] + "%");
    $('#retentionD30').text(dicRetentionPercent[30] + "%");

    showUserSessionSnapShot(version);
    calculateUserProperty(version);
  }

  let countUserTrash = 0;
  const delay = ms => new Promise(res => setTimeout(res, ms));

  async function showUserSessionSnapShot(version){
    let project = $('input[name=project]:checked').val();
    let versionData = dicSessionDatas[project][version];

    countUserTrash = 0;
    let count = 0;
    $('#userSessionGroup').children().remove();
    for (const userId in versionData) {
      let user = versionData[userId];
      let index = 0;
      for (const sessionId in user) {
        let session = user[sessionId];
        let actions = session["actions"];
        if (actions == null){
          countUserTrash++;
        }
        try {
          drawActionBoard(session, index);
        } catch (error){
          console.log(error);
        }
        await delay(100);
        index++;
        count++;
      }
    }
    console.log("draw action boards count = " + count);
  }

  function countMarketingTrashPercent(dicNewUserByDate){
    let project = $('input[name=project]:checked').val();
    let projectData = dicProjectDatas[project];
    let userMarketingCount = projectData["userCount"];

    let dicUserCount = {};
    let allKey = [];

    for (const mKey in userMarketingCount){
      let month = userMarketingCount[mKey];
      for (const dKey in month){
        let date = mKey + dKey;
        let value = month[dKey];
        dicUserCount[date] = value;
        if (allKey.includes(date) == false) allKey.push(date);
      }
    }

    let trashPercent = [];
    let reportedUser = [];
    let realUser = [];

    for (const index in allKey){
      let key = allKey[index];
      let realUserCount = 0;
      let repotedUserCount = 0;

      if (dicNewUserByDate[key] != null) realUserCount = dicNewUserByDate[key];
      if (dicUserCount[key] != null) repotedUserCount = dicUserCount[key];

      if (dicNewUserByDate[key] == null || dicUserCount[key] == 0 || realUserCount > repotedUserCount || realUserCount <= 5) {
        trashPercent.push(0);
      } else {
        let percent = (1 - dicNewUserByDate[key] / dicUserCount[key]) *100;
        trashPercent.push(percent.toFixed(2));
      }
      reportedUser.push(repotedUserCount);
      realUser.push(realUserCount);
    }
    drawMarketingTrashPercent("chartMarketingTrashPercent", allKey, reportedUser, realUser, trashPercent);
    drawMarketingCPI("chartMarketingCPI", allKey, reportedUser, realUser, trashPercent);
  }

  function countUserTrashPercent(rawData){
    let dicTrashUser = {};

    for (const versionName in rawData){
      let versionData = rawData[versionName];
      countUserTrash = 0;
      let count = 0;
      for (const userId in versionData) {
        let user = versionData[userId];
        let index = 0;
        let isTrashUser = true;
        for (const sessionId in user) {
          let isRealUser = user[sessionId]['installer'] == 'com.android.vending';
          if (isRealUser == false) continue;

          let session = user[sessionId];
          let actions = session["actions"];
          if (actions != null){
            if (actions.length > 0) isTrashUser = false;
          }
        }
        if (isTrashUser) countUserTrash++;
        count++;
      }
      console.log("version " + versionName + " trash user count = " + countUserTrash);
      console.log("percent " + versionName + " trash user percent count = " + (countUserTrash / count *100).toFixed(2));
      if (count >= MIN_NUMBER_USER_ANALYTICS){
        dicTrashUser[versionName] = (countUserTrash / count *100).toFixed(2);
      }
    }
    drawChartByDictionary("chartTrashUserPercent", "Trash User Percent", dicTrashUser);    
  }  

  function drawActionBoard(session, index){
    let isRealUser = session['installer'] == 'com.android.vending';
    if (isRealUser == false) return;

    let actions = session["actions"];
    let colors = [];
    let values = [];
    let names = [];

    if (actions == null) return;

    for (let i = 0; i < actions.length; i++) {
      let color = "transparent";

      let action = actions[i];

      if (action.includes("exception")){
        action = "exception";
        color = "black";
      }
      else if (action.includes("level")){
        if (action.includes("pass")){
          color = "green";
        } else if (action.includes("fail")){
          color = "red";
        }
      } else {
        if (action.includes("app open")){
          color = "orange";
        } else if (action.includes("success")){
          color = "purple";
        } else if (action.includes("fail")){
          color = "pink";
        }
      }

      colors.push(color);
      values.push(1);
      names.push(action);
    }

    let id = session["id"] + "_" + index;
    let chartName = "chartUserSession_" + id;
    let htmlPattern = 
    `  <div class="row ">
        <div class="col-4">
          <table class="table table-striped">
            <thead>
              <tr>
                <th scope="col">#</th>
                <th scope="col">Name</th>
                <th scope="col">Value</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <th scope="row">1</th>
                <td>User Id</td>
                <td><span id="snapShotUserId_${id}">30%</span></td>
              </tr>
              <tr>
                <th scope="row">1</th>
                <td>Session Time</td>
                <td><span id="snapShotSessionTime_${id}">30%</span></td>
              </tr>
              <tr>
                <th scope="row">1</th>
                <td>Total Time</td>
                <td><span id="snapShotTotalTime_${id}">30%</span></td>
              </tr>
              <tr>
                <th scope="row">1</th>
                <td>Quit Reason</td>
                <td><span id="snapShotQuitReason_${id}">30%</span></td>
              </tr>
              <tr>
                <th scope="row">1</th>
                <td>Last Level</td>
                <td><span id="snapShotQuitReasonLevel_${id}">30%</span></td>
              </tr>
              <tr>
                <th scope="row">1</th>
                <td>Last Lose Count</td>
                <td><span id="snapShotQuitReasonLoseCount_${id}">30%</span></td>
              </tr>
            </tbody>
          </table>
        </div>
        <div class="col-8">
          <canvas id="${chartName}" "></canvas>
        </div>
    </div>`;
    $('#userSessionGroup').append(htmlPattern);

    drawChartWithColors(chartName, "User action snapshot", names, values, colors);

    let sessionTime = Number(session["sessionTime"]) / 60;
    let totalTime = Number(session["totalTime"]) / 60;
    let quitReason = session["quitReason"];
    $("#snapShotUserId_" + id).text(session["id"]);
    $("#snapShotLanguage_" + id).text(session["language"]);
    $("#snapShotSessionTime_" + id).text(sessionTime.toFixed(2));
    $("#snapShotTotalTime_" + id).text(totalTime.toFixed(2));
    $("#snapShotQuitReason_" + id).text(quitReason["type"]);
    $("#snapShotQuitReasonLevel_" + id).text(quitReason["level"]);
    $("#snapShotQuitReasonLoseCount_" + id).text(quitReason["loseCount"]);
  }

  let dicLevel = {};
  let dicLose = {};
  let dicWin = {};
  let dicLevelTimeSpent = {};
  let dicLevelCount = {};
  let dicUserDropPercent = {};
  let dicLevelPlayCount = {};
  let dicUserByLosePercent = {};

  let countUserNoob = 0;
  let playTimeUserNoob = 0;
  
  function calculateLevel(versionData){
    dicLevel = {};
    dicLevelCount = {};
    dicLose = {};
    dicWin = {};
    dicLevelTimeSpent = {};    
    dicUserDropPercent = {};
    dicLevelPlayCount = {};
    dicUserByLosePercent = {};
    dicUserPlaytimeByLosePercent = {};

    countUserNoob = 0;

    let userCount = 0;
    let maxLevel = 0;

    for (const userId in versionData) {
      let user = versionData[userId];
      let isRealUser = user['installerName'] == 'com.android.vending';
      if (isRealUser == false) continue;

      let winlose = user["winloseDatas"];
      if (winlose == null) continue;

      userCount++;
      let level = user["level"];
      if (level > maxLevel) maxLevel = level;

      count(dicLevel, level);
      for (let i = 0; i <= level; i++) {
        count(dicLevelCount, i);
      }

      let isNoob = false;
      let sumLose = 0;
      let sumLevelPlayCount = 0;

      for (const level in winlose) {
        let winloseData = winlose[level];
        add(dicLose, level, winloseData["loseCount"]);
        add(dicWin, level, winloseData["winCount"]);
        add(dicLevelTimeSpent, level, winloseData["timeSpent"]);
        count(dicLevelPlayCount, level);
        sumLose += winloseData["loseCount"];
        sumLevelPlayCount += winloseData["loseCount"] + winloseData["winCount"];
        if (dicLose[level] >= 3 && level < 3){
          isNoob = true;
        }
      }
      if (isNoob) countUserNoob++;

      let losePercent = Math.floor((sumLose / sumLevelPlayCount).toFixed(2)*100);
      // console.log("user lose percent = " + losePercent);
      count(dicUserByLosePercent, losePercent);
      add(dicUserPlaytimeByLosePercent, losePercent, user["totalPlayTime"]);
    }

    for (let i = 1; i <= maxLevel; i++) {
      let percent = (1 - dicLevelCount[i]/dicLevelCount[i-1]) *100;
      dicUserDropPercent[i-1] = percent.toFixed(2);
    }
    // dicUserDropPercent[maxLevel] = 100;

    let dicWinPercent = {};

    for (const key in dicLose) {
      if (dicWin[key] == null) continue;
      let lose = dicLose[key];
      let win = dicWin[key];
      dicWinPercent[key] = ((lose / (win + lose)) *100).toFixed(2);
    }

    let dicLosePerUser = {};
    for (const key in dicLose) {
      dicLosePerUser[key] = dicLose[key] / dicLevelPlayCount[key];
    }
    
    for (const key in dicLevelTimeSpent) {
      dicLevelTimeSpent[key] = dicLevelTimeSpent[key] / dicLevelPlayCount[key];
    }

    for (const key in dicUserPlaytimeByLosePercent) {
      let avgPlayTime = dicUserPlaytimeByLosePercent[key] / dicUserByLosePercent[key];
      dicUserPlaytimeByLosePercent[key] = (avgPlayTime / 60).toFixed(2);
    }

    console.log("finish, dicUserPlaytimeByLosePercent = ");
    console.log(dicUserPlaytimeByLosePercent);

    //chartPlayTimeByLoseLevel
    // drawChartByDictionary("chartUserLevel", "User by level", dicLevel);
    drawChartByDictionary("chartUserLevelCount", "Number user pass level", dicLevelCount);
    drawChartByDictionary("chartLevelLose", "Lose Level Count Per User", dicLosePerUser);
    drawChartByDictionary("chartLevelTimeSpent", "Level Time Spent Per User", dicLevelTimeSpent);
    drawChartByDictionary("chartLevelWinPercent", "Level Lose Percent", dicWinPercent);
    drawChartByDictionary("chartLevelDropPercent", "User Give Up Percent by level", dicUserDropPercent);
    drawChartByDictionary("chartUserByLosePercent", "User count by lose percent", dicUserByLosePercent);
    drawChartByDictionary("chartUserPlayTimeByLosePercent", "User play time by lose percent", dicUserPlaytimeByLosePercent);
  }

  function isNoobUser(userData){
    let winlose = user["winloseDatas"];
    if (winlose == null) return true;

    let isNoob = false;
    let loseCount = 0;

    for (const level in winlose) {
      let winloseData = winlose[level];
      loseCount += winloseData["loseCount"];
      if (loseCount >= 3 && level < 3){
        isNoob = true;
      }
    }

    return isNoob;
  }

  let dicQuitReason = {};
  let dicQuitReason_BoringGameplay = {};
  let dicQuitReason_IntertistialAds = {};

  function calculateQuitReason(versionData){
    dicQuitReason = {};

    userCount = 0;
    for (const userId in versionData) {
      let user = versionData[userId];
      let isRealUser = user['installerName'] == 'com.android.vending';
      if (isRealUser == false) continue;

      let quitReason = user["quitReason"];
      if (quitReason == null) continue;

      userCount++;
      let type = quitReason["type"];
      let level = quitReason["level"];

      count(dicQuitReason, type);
      if (type == "BoringGameplay"){
        count(dicQuitReason_BoringGameplay, level);
      }
      if (type == "IntertistialAds"){
        count(dicQuitReason_IntertistialAds, level);
      }
    }

    for (const key in dicQuitReason) {
      dicQuitReason[key] = ((dicQuitReason[key] / userCount) *100).toFixed(2);
    }
    drawChartByDictionary("chartQuitReason", "Quit Reason (%)", dicQuitReason);
    drawChartByDictionary("chartQuitReason_BoringGameplay", "Quit Boring Gameplay by level", dicQuitReason_BoringGameplay);
    drawChartByDictionary("chartQuitReason_IntertistialAds", "Quit Intertistial Ads by level", dicQuitReason_IntertistialAds);
  }

  let dicUserProperty = {};
  let dicUserPropertyPercent = {};

  function calculateUserProperty(version){
    let project = $('input[name=project]:checked').val();
    let versionData = dicUserDatas[project][version];
    let sessionData = dicSessionDatas[project][version];

    let userCount = 0;
    let userTrashCount = 0;
    let userHaveSessions = [];

    dicUserProperty = {};;
    dicUserPropertyPercent = {};

    for (const userId in sessionData) {
      let data = sessionData[userId];
      let index = 0;
      for (const sessionId in data) {
        let session = data[sessionId];
        let actions = session["actions"];
        let id = session["id"];

        if (userHaveSessions.includes(id) == false) {
          userHaveSessions.push(id);
        }
      }
    }

    for (const userId in versionData) {
      let user = versionData[userId];
      let isRealUser = user['installerName'] == 'com.android.vending';
      if (isRealUser == false) continue;
      userCount++;

      if (userHaveSessions.includes(user["id"]) == false){
        countUserTrash++;
      }
    }

    dicUserProperty = {};
    dicUserProperty["total"] = userCount;
    dicUserProperty["user trash"] = countUserTrash;
    dicUserProperty["user noob"] = countUserNoob;

    dicUserPropertyPercent = {};
    dicUserPropertyPercent["total"] = userCount / userCount * 100; 
    dicUserPropertyPercent["user trash"] = (countUserTrash / userCount * 100).toFixed(2);
    dicUserPropertyPercent["user noob"] = (countUserNoob / userCount * 100).toFixed(2);

    drawChartByDictionary("chartUserProperty", "User by property", dicUserProperty);
    drawChartByDictionary("chartUserPropertyPercent", "User by property percent", dicUserPropertyPercent);
  }

  let revenueBanner = 0;
  let revenueIntertistial = 0;
  let revenueRewarded = 0;
  let revenueAppOpen = 0;
  let sessionCount = 0;

  let impressionBanner = 0;
  let impressionIntertistial = 0;
  let impressionRewarded = 0;
  let impressionAppOpen = 0;
  let totalRevenue = 0;
  let totalImpression = 0;

  let dicRevenue = {};
  let dicRevenuePerUser = {};
  let dicRevenuePerImpression = {};
  let dicImpressionPerUser = {};
  let dicImpressionPerSession = {};

  function calculateRevenue(versionData){
    dicRevenue = {};
    dicRevenuePerUser = {};
    dicRevenuePerImpression = {};
    dicImpressionPerUser = {};
    dicImpressionPerSession = {};

    revenueBanner = 0;
    revenueIntertistial = 0;
    revenueRewarded = 0;
    revenueAppOpen = 0;
    sessionCount = 0;

    impressionBanner = 0;
    impressionIntertistial = 0;
    impressionRewarded = 0;
    impressionAppOpen = 0;

    totalRevenue = 0;

    let userCount = 0;

    for (const userId in versionData) {
      let user = versionData[userId];
      let isRealUser = user['installerName'] == 'com.android.vending';
      if (isRealUser == false) continue;

      userCount++;
      sessionCount += user["sessionCount"];
      let revenue = user["revenue"];
      if (revenue == null) continue;

      revenueBanner += revenue["bannerRevenue"];
      revenueIntertistial += revenue["interRevenue"];
      revenueRewarded += revenue["rewardRevenue"];
      revenueAppOpen += revenue["appOpenRevenue"];

      impressionBanner += revenue["bannerSuccess"];
      impressionIntertistial += revenue["interSuccess"];
      impressionRewarded += revenue["rewardSuccess"];
      impressionAppOpen += revenue["appOpenSuccess"];
      
      // console.log("revenue detail = " + revenue);
    }
    totalRevenue = revenueAppOpen + revenueBanner + revenueIntertistial + revenueRewarded;
    totalImpression = impressionBanner + impressionAppOpen + impressionIntertistial + impressionRewarded;

    dicRevenue["total"] = totalRevenue;
    dicRevenue["banner"] = revenueBanner;
    dicRevenue["intertistial"] = revenueIntertistial;
    dicRevenue["rewarded"] = revenueRewarded;
    dicRevenue["app open"] = revenueAppOpen;

    dicRevenuePerUser["total"] = totalRevenue / userCount;
    dicRevenuePerUser["banner"] = revenueBanner / userCount;
    dicRevenuePerUser["intertistial"] = revenueIntertistial / userCount;
    dicRevenuePerUser["rewarded"] = revenueRewarded / userCount;
    dicRevenuePerUser["app open"] = revenueAppOpen / userCount;

    dicRevenuePerImpression["total"] = totalRevenue / totalImpression;
    dicRevenuePerImpression["banner"] = revenueBanner / impressionBanner;
    dicRevenuePerImpression["intertistial"] = revenueIntertistial / impressionIntertistial;
    dicRevenuePerImpression["rewarded"] = revenueRewarded / impressionRewarded;
    dicRevenuePerImpression["app open"] = revenueAppOpen / impressionAppOpen;

    dicImpressionPerUser["total"] = totalImpression / userCount;
    dicImpressionPerUser["banner"] = impressionBanner / userCount;
    dicImpressionPerUser["intertistial"] = impressionIntertistial / userCount;
    dicImpressionPerUser["rewarded"] = impressionRewarded / userCount;
    dicImpressionPerUser["app open"] = impressionAppOpen / userCount;

    dicImpressionPerSession["total"] = totalImpression / sessionCount;
    dicImpressionPerSession["banner"] = impressionBanner / sessionCount;
    dicImpressionPerSession["intertistial"] = impressionIntertistial / sessionCount;
    dicImpressionPerSession["rewarded"] = impressionRewarded / sessionCount;
    dicImpressionPerSession["app open"] = impressionAppOpen / sessionCount;

    drawChartByDictionary("chartRevenue", "Revenue", dicRevenue);
    drawChartByDictionary("chartRevenuePerUser", "Revenue Per User", dicRevenuePerUser);
    drawChartByDictionary("chartRevenuePerImpression", "Revenue Per Impression", dicRevenuePerImpression);
    drawChartByDictionary("chartImpressionPerUser", "Impression Per User", dicImpressionPerUser);
    drawChartByDictionary("chartImpressionPerSession", "Impression Per Session", dicImpressionPerSession);

    $("#revenueThisVersion").text(dicRevenue["total"].toFixed(4));
    $("#revenuePerUser").text(dicRevenuePerUser["total"].toFixed(4));

    $("#revenueInterPerUser").text(dicImpressionPerUser["intertistial"].toFixed(2));
    $("#revenueRewardPerUser").text(dicImpressionPerUser["rewarded"].toFixed(2));
    $("#revenueAppOpenPerUser").text(dicImpressionPerUser["app open"].toFixed(2));
    $("#revenueBannerPerUser").text(dicImpressionPerUser["banner"].toFixed(2));

    $("#revenueImpressionPerUser").text(dicImpressionPerUser["total"].toFixed(4));
  }

  function count(dic, key){
    if (dic[key] == null){
      dic[key] = 1;
    } else {
      dic[key]++;
    }
  }

  function add(dic, key, value){
    if (dic[key] == null){
      dic[key] = value;
    } else {
      dic[key] += value;
    }
  }

  function drawChartByDictionary(chartName, title, dic){
    let columnNames = [];
    let values = [];
    for (const key in dic) {
      columnNames.push(key);
      values.push(dic[key]);
    }
    drawChart(chartName, title, columnNames, values);
  }

  function drawChartWithColors(chartName, title, columnNames, values, colors){
    if (dicCharts[chartName] != null) {
      dicCharts[chartName].destroy();
    }
    let chart = new Chart(chartName, {
      type: "bar",
      data: {
        labels: columnNames,
        datasets: [{
          label: title,
          backgroundColor: colors,
          data: values
        }]
      },
      options: {
        scales: {
          yAxes: [{
            ticks: {
              beginAtZero: true
            }
          }]
        }
      }
    });
    dicCharts[chartName] = chart;
  }

  function drawChart(chartName, title, columnNames, values) {
    let barColors = [];
    let colors = ["green", "blue", "purple", "red", "orange"];
    for (let i = 0; i < columnNames.length; i++) {
      let colorIndex = i % colors.length;
      barColors.push(colors[colorIndex]);
    }

    return drawChartWithColors(chartName, title, columnNames, values, barColors);
  }

  const MIN_NUMBER_USER_ANALYTICS = 5;

  let retentionDay0 = 0;
  let retentionDay1 = 0;
  let totalPlayTime = 0;
  let totalSessionCount = 0;
  let userCount = 0;

  function calculateAll(allData) {
    retentionDay0 = 0;
    retentionDay1 = 0;
    totalPlayTime = 0;
    totalSessionCount = 0;
    userCount = 0;

    for (const property in allData) {
      var user = allData[property];
      let isRealUser = user['installerName'] == 'com.android.vending';
      if (isRealUser == false) continue;
      userCount++;

      let playTime = user["totalPlayTime"];
      totalPlayTime += playTime;

      let sessionCount = user["sessionCount"];
      totalSessionCount += sessionCount;
    }
  }

  function drawMarketingChart(chartName, columnNames, adSpend, revenue, profit){
    if (dicCharts[chartName] != null) {
      dicCharts[chartName].destroy();
    }
    let chart = new Chart(chartName, {
      type: "line",
      data: {
        labels: columnNames,
        datasets: [{
          label: "ad spend",
          backgroundColor: "red",
          data: adSpend,
          borderColor: "red",
          fill: false
        },
        {
          label: "revenue",
          backgroundColor: "blue",
          data: revenue,
          borderColor: "blue",
          fill: false
        },
        {
          label: "profit",
          backgroundColor: "green",
          data: profit,
          borderColor: "green",
          fill: false
        }
      ]
      },
      options: {
        scales: {
          yAxes: [{
            ticks: {
              // beginAtZero: true
            }
          }]
        }
      }
    });
    dicCharts[chartName] = chart;
  }

  function drawMarketingTrashPercent(chartName, columnNames, reportedUser, realUser, trashPercent){
    if (dicCharts[chartName] != null) {
      dicCharts[chartName].destroy();
    }
    let chart = new Chart(chartName, {
      type: "line",
      data: {
        labels: columnNames,
        datasets: [{
          label: "reported user count",
          backgroundColor: "blue",
          data: reportedUser,
          borderColor: "blue",
          fill: false
        },
        {
          label: "real user count",
          backgroundColor: "green",
          data: realUser,
          borderColor: "green",
          fill: false
        },
        {
          label: "trash user pecent",
          backgroundColor: "red",
          data: trashPercent,
          borderColor: "red",
          fill: false
        }
      ]
      },
      options: {
        scales: {
          yAxes: [{
            ticks: {
              // beginAtZero: true
            }
          }]
        }
      }
    });
    dicCharts[chartName] = chart;
  }

  function drawLineChart(chartName, columnNames, dataLabels, dataValues, dataColors){
    if (dicCharts[chartName] != null) {
      dicCharts[chartName].destroy();
    }
    let sets = [];
    for (let i =0;i < dataLabels.length; i++){
      let data = {};
      data.label = dataLabels[i];
      data.backgroundColor = dataColors[i];
      data.data = dataValues[i];
      data.borderColor = dataColors[i];
      data.fill = false;

      sets.push(data);
    }
    let chart = new Chart(chartName, {
      type: "line",
      data: {
        labels: columnNames,
        datasets: sets
      },
      options: {
        scales: {
          yAxes: [{
            ticks: {
              // beginAtZero: true
            }
          }]
        }
      }
    });
    dicCharts[chartName] = chart;
  }

</script>

</html>